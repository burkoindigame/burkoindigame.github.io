<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Предзаказ игры</title>
  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <h1>Предзаказ вашей игры</h1>
  <button id="payButton">Оплатить 0.0002385 ETH</button>
  <div id="status"></div>
  
  <div id="form" style="display:none;">
    <input type="text" id="name" placeholder="Ваше имя" required>
    <input type="email" id="email" placeholder="Ваш email" required>
    <button id="submit">Отправить</button>
  </div>

  <script>
    // Инициализация EmailJS
    (function(){
        emailjs.init({publicKey: "rp0sKAlvyGeosNICv"}); // Замените на ваш User ID
    })();

    const payButton = document.getElementById('payButton');
    const statusDiv = document.getElementById('status');
    const form = document.getElementById('form');
    const submitButton = document.getElementById('submit');

    async function payWithMetaMask() {
      if (typeof window.ethereum === 'undefined') {
        statusDiv.innerText = 'Пожалуйста, установите MetaMask!';
        return;
      }

      try {
        // Запросить доступ к аккаунту
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const from = accounts[0];

        // Адрес получателя (ваш кошелек)
        const to = '0x4C28A84bBFE53BEB74418E0dfD36c5bca4b38614'; // Замените на ваш Ethereum-адрес

        // Сумма в wei (0.0002385 ETH)
        const amountEth = 0.0002385;
        const valueWei = BigInt(Math.round(amountEth * 1e18)).toString(16);

        // Отправка транзакции
        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from,
            to,
            value: '0x' + valueWei,
          }],
        });

        statusDiv.innerText = 'Транзакция отправлена. Хэш: ' + txHash;
        
        // Показать форму после успешной оплаты
        form.style.display = 'block';
      } catch (error) {
        statusDiv.innerText = 'Ошибка: ' + error.message;
      }
    }

    payButton.addEventListener('click', payWithMetaMask);

    submitButton.onclick = async () => {
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;

      // Отправка данных через EmailJS
      emailjs.send('service_wlsifjm', 'template_ennh41a', {
          name: name,
          email: email
      })
      .then((response) => {
          alert('Предзаказ успешно оформлен!');
      }, (error) => {
          alert('Ошибка при оформлении предзаказа: ' + JSON.stringify(error));
      });
    };
  </script>
</body>
</html>
